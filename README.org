# SPDX-License-Identifier: MIT

* OpenWeatherMap API Client

Common Lisp client library for multiple OpenWeatherMap APIs: https://openweathermap.org/api

** âœ¨ AI Disclosure
Large portions of the codebase are AI-assisted. For more information checkout =AGENTS.md= and =/plans=.

** Status
This repository is in early bootstrap.

** Goals
- Idiomatic Common Lisp client interface.
- Strong unit test suite.
- Separate integration test suite for live API checks.
- Project-local OpenAPI specifications per API family.

** Quick Start
*** Prerequisites
- SBCL
- ASDF
- Quicklisp (for external dependencies such as FiveAM)
- Node.js (required for OpenAPI linting with Redocly CLI)
  - Recommended: Node >= 20.19.0 (or >= 22.12.0)
- npm

*** Install development dependencies
#+begin_src sh
npm install
#+end_src

This installs =@redocly/cli= for OpenAPI spec validation.

*** Run unit tests
#+begin_src sh
make unit
#+end_src

*** Start REPL
Load the main library system:
#+begin_src sh
make repl
#+end_src

Load test systems in REPL:
#+begin_src sh
make repl-tests
make repl-integration
#+end_src

*** Run integration tests
Set your API key and enable live integration runs:
#+begin_src sh
export OPENWEATHER_API_KEY="your-key"
export OPENWEATHERMAP_RUN_LIVE_TESTS=1
make integration
#+end_src

Per-API integration smoke targets:
#+begin_src sh
make integration-onecall
make integration-current
make integration-forecast
make integration-geocoding
make integration-air-pollution
make integration-maps
#+end_src

If =OPENWEATHERMAP_RUN_LIVE_TESTS= is not set to =1= (or =true/=yes), integration tests are skipped.

*** Validate OpenAPI spec
#+begin_src sh
make spec-check
#+end_src

*** Refresh weather condition mapping artifacts
#+begin_src sh
make update-weather-conditions
#+end_src

** Development Workflow
- Use =make check= for local quality checks.
- Use =make unit= or =make check= for deterministic non-live checks (CI-safe default).
- Use =make update-weather-conditions= to refresh generated weather condition/icon data files from OpenWeather docs.
- Keep implementation in =src/=.
- Keep unit tests in =tests/=.
- Keep live API integration tests in =integration-tests/=.
- Keep plans in =plans/=.
- Keep API specs in =spec/= (one file per API family).
- Update =CHANGELOG.md= for each session.

** API Surface Conventions
- Module layout by API family:
  - =src/apis/current.lisp=
  - =src/apis/forecast.lisp=
  - =src/apis/geocoding.lisp=
  - =src/apis/air-pollution.lisp=
  - =src/apis/maps.lisp=
  - =src/client.lisp= keeps shared request/retry/decode pipeline.
- Function naming:
  - =build-*= functions generate endpoint URLs.
  - =make-*= functions return request metadata plist =(:method :get :url "...")=.
  - =fetch-*= functions execute HTTP and return decoded plist responses (or raw tile payload for maps).
- Response strategy:
  - Baseline representation is plist decoded from JSON.
  - Structured/typed response objects may be added later without breaking this baseline.

** Public API (Current Draft)
Configure client settings:
#+begin_src lisp
(openweathermap:configure-api-key "your-api-key")
(openweathermap:configure-client
 :request-timeout-seconds 10
 :max-retries 2
 :retry-backoff-seconds 1)
#+end_src

Fetch JSON-decoded responses (plist form):
#+begin_src lisp
(openweathermap:fetch-current-weather :q "London" :units :metric)
(openweathermap:fetch-forecast :q "London" :units :metric :cnt 8)
(openweathermap:fetch-geocoding "London" :limit 5)
(openweathermap:fetch-reverse-geocoding 35.0 139.0 :limit 1)
(openweathermap:fetch-zip-geocoding "94040" :country-code "US")
(openweathermap:fetch-air-pollution 35.0 139.0)
(openweathermap:fetch-air-pollution-forecast 35.0 139.0)
(openweathermap:fetch-air-pollution-history 35.0 139.0 1700000000 1700003600)
(openweathermap:fetch-weather-tile :temp_new 3 4 5 :opacity 0.7)
(openweathermap:fetch-onecall 35.0 139.0 :units :metric :lang "en")
(openweathermap:fetch-timemachine 35.0 139.0 1700000000 :units :metric)
(openweathermap:fetch-day-summary 35.0 139.0 "2026-02-15" :units :metric)
(openweathermap:fetch-overview 35.0 139.0 :date "2026-02-16")
#+end_src

Build request URLs only (no network call):
#+begin_src lisp
(openweathermap:build-current-weather-url :lat 35.0 :lon 139.0 :units :metric)
(openweathermap:build-forecast-url :lat 35.0 :lon 139.0 :units :metric :cnt 8)
(openweathermap:build-geocoding-url "London" :limit 5)
(openweathermap:build-reverse-geocoding-url 35.0 139.0 :limit 1)
(openweathermap:build-zip-geocoding-url "94040" :country-code "US")
(openweathermap:build-air-pollution-url 35.0 139.0)
(openweathermap:build-air-pollution-forecast-url 35.0 139.0)
(openweathermap:build-air-pollution-history-url 35.0 139.0 1700000000 1700003600)
(openweathermap:build-weather-tile-url :temp_new 3 4 5 :opacity 0.7)
(openweathermap:build-onecall-url 35.0 139.0 :units :metric)
(openweathermap:build-timemachine-url 35.0 139.0 1700000000)
(openweathermap:build-day-summary-url 35.0 139.0 "2026-02-15")
(openweathermap:build-overview-url 35.0 139.0)
#+end_src

Weather condition helpers:
#+begin_src lisp
(openweathermap:lookup-weather-condition 500)
(openweathermap:weather-icon-url "10d")                 ; => .../10d@2x.png
(openweathermap:weather-icon-url "10d" :size :1x)       ; => .../10d.png
(openweathermap:resolve-weather-condition
 :id 500 :icon "10n" :description "light rain" :main "Rain")
(openweathermap:enrich-weather-entry
 '(:id 801 :main "Clouds" :description "few clouds" :icon "02n"))
(openweathermap:enrich-weather-list
 '((:id 800 :main "Clear" :description "clear sky" :icon "01d")
   (:id 500 :main "Rain" :description "light rain" :icon "10n")))
#+end_src

*** Weather Condition Helper API
| Function | Signature | Returns | Notes |
|----------+-----------+---------+-------|
| =lookup-weather-condition= | =(condition-id)= | plist or =NIL= | Looks up canonical condition by numeric ID (e.g. =500=). |
| =weather-icon-url= | =(icon-code &key size secure-p)= | string URL | Icon code must be =NNd= or =NNn=. =size= accepts =:1x=, =:2x= (default), =:4x=. |
| =resolve-weather-condition= | =(&key id icon description main)= | plist | Merges payload fields with canonical mapping; includes fallback metadata and =:unknown-condition-p=. |
| =enrich-weather-entry= | =(weather-entry)= | plist | Enriches one weather object plist from API payload. |
| =enrich-weather-list= | =(weather-list)= | list | Maps enrichment across list of weather objects. |

Resolution behavior:
- Payload =:description= and =:icon= are preferred when present.
- Canonical mapping is used as fallback and for metadata like =:icon-day= / =:icon-night=.
- Unknown condition IDs do not error; result marks =:unknown-condition-p= as true.

** Parameter Reference
This client accepts Common Lisp values and serializes them into query params.

*** Common Optional Params
| Param    | Type          | Allowed / Format                     | Example                    | Used By                    |
|----------+---------------+--------------------------------------|----------------------------|----------------------------|
| =:units= | symbol/string | =:standard=, =:metric=, =:imperial= | =:units :metric=           | One Call, Current, Forecast |
| =:lang=  | string        | language code                        | =:lang "en"=               | One Call, Current, Forecast |
| =:mode=  | string        | API-supported response mode          | =:mode "json"=             | Current, Forecast          |

*** Endpoint Parameters
| Endpoint Family | Function(s)                             | Param             | Type                  | Required | Notes / Example                                |
|-----------------+-----------------------------------------+-------------------+-----------------------+----------+------------------------------------------------|
| One Call        | =fetch-onecall= / =build-onecall-url=  | =lat=, =lon=      | number                | yes      | positional args                                |
| One Call        | =fetch-onecall= / =build-onecall-url=  | =:exclude=        | string                | no       | comma-separated, e.g. ="minutely,alerts"=      |
| Timemachine     | =fetch-timemachine=                    | =dt=              | integer               | yes      | UNIX timestamp                                 |
| Day Summary     | =fetch-day-summary=                    | =date=            | string                | yes      | =YYYY-MM-DD=                                   |
| Day Summary     | =fetch-day-summary=                    | =:tz=             | string                | no       | timezone offset/name per API docs              |
| Overview        | =fetch-overview=                       | =:date=           | string                | no       | =YYYY-MM-DD=                                   |
| Current/Forecast| =fetch-current-weather=, =fetch-forecast= | location selector | see note              | yes      | one of =:lat/:lon=, =:q=, =:id=, or =:zip=     |
| Forecast        | =fetch-forecast=                       | =:cnt=            | integer               | no       | number of forecast entries                     |
| Geocoding       | =fetch-geocoding=                      | query (positional)| non-empty string      | yes      | city/place query                               |
| Geocoding       | =fetch-geocoding=                      | =:limit=          | integer               | no       | max results                                    |
| Reverse Geo     | =fetch-reverse-geocoding=              | =lat=, =lon=      | number                | yes      | positional args                                |
| Reverse Geo     | =fetch-reverse-geocoding=              | =:limit=          | integer               | no       | max results                                    |
| ZIP Geo         | =fetch-zip-geocoding=                  | zip (positional)  | non-empty string      | yes      | e.g. ="94040"=                                 |
| ZIP Geo         | =fetch-zip-geocoding=                  | =:country-code=   | string                | no       | e.g. ="US"=                                    |
| Air Pollution   | =fetch-air-pollution=, =...-forecast= | =lat=, =lon=      | number                | yes      | positional args                                |
| Air History     | =fetch-air-pollution-history=          | =start=, =end=    | integer               | yes      | UNIX timestamps, =start <= end=                |
| Maps            | =fetch-weather-tile=                   | layer             | keyword/string/symbol | yes      | e.g. =:temp_new=, =:clouds_new=                |
| Maps            | =fetch-weather-tile=                   | =z=, =x=, =y=     | non-negative integer  | yes      | tile coordinates                               |
| Maps            | =fetch-weather-tile=                   | =:opacity=        | number                | no       | e.g. =0.7=                                     |
| Maps            | =fetch-weather-tile=                   | =:palette=        | string                | no       | e.g. ="warm/cold"=                             |

** Response Types (Draft)
The table below summarizes successful (=200 OK=) response shapes based on OpenWeather docs and current project specs.

| API Family / Endpoint | Function(s) | Response Type | Top-level fields (typical) |
|-----------------------+-------------+---------------+----------------------------|
| One Call =/data/3.0/onecall= | =fetch-onecall= | JSON object (plist) | =lat= number, =lon= number, =timezone= string, =timezone_offset= integer, =current= object, =minutely= array, =hourly= array, =daily= array, =alerts= array |
| One Call Timemachine =/data/3.0/onecall/timemachine= | =fetch-timemachine= | JSON object (plist) | =lat=, =lon=, =timezone=, =timezone_offset=, =data= array of weather objects |
| One Call Day Summary =/data/3.0/onecall/day_summary= | =fetch-day-summary= | JSON object (plist) | =lat=, =lon=, =tz=, =date= (YYYY-MM-DD), =units=, =temperature= object, =humidity= object, =cloud_cover= object, =pressure= object, =precipitation= object, =wind= object |
| One Call Overview =/data/3.0/onecall/overview= | =fetch-overview= | JSON object (plist) | =lat=, =lon=, =tz=, =date=, =units=, =weather_overview= string |
| Current Weather =/data/2.5/weather= | =fetch-current-weather= | JSON object (plist) | =coord= object, =weather= array, =base= string, =main= object, =visibility= integer, =wind= object, =clouds= object, =rain= object?, =snow= object?, =dt= integer, =sys= object, =timezone= integer, =id= integer, =name= string, =cod= integer/string |
| Forecast =/data/2.5/forecast= | =fetch-forecast= | JSON object (plist) | =cod= string, =message= number, =cnt= integer, =list= array (forecast steps), =city= object |
| Geocoding Direct =/geo/1.0/direct= | =fetch-geocoding= | JSON array (list) | each item typically has =name= string, =local_names= object?, =lat= number, =lon= number, =country= string, =state= string? |
| Geocoding Reverse =/geo/1.0/reverse= | =fetch-reverse-geocoding= | JSON array (list) | same item shape as direct geocoding |
| Geocoding ZIP =/geo/1.0/zip= | =fetch-zip-geocoding= | JSON object (plist) | =zip= string, =name= string, =lat= number, =lon= number, =country= string |
| Air Pollution Current =/data/2.5/air_pollution= | =fetch-air-pollution= | JSON object (plist) | =coord= object, =list= array; each item includes =dt=, =main= (=aqi=), =components= (pollutant concentrations) |
| Air Pollution Forecast =/data/2.5/air_pollution/forecast= | =fetch-air-pollution-forecast= | JSON object (plist) | same top-level shape as current air pollution |
| Air Pollution History =/data/2.5/air_pollution/history= | =fetch-air-pollution-history= | JSON object (plist) | same top-level shape as current air pollution |
| Maps Tile =/map/{layer}/{z}/{x}/{y}.png= | =fetch-weather-tile= | Binary payload | PNG image bytes/string payload (not JSON) |

Notes:
- In Lisp, JSON objects are decoded as property lists by default.
- JSON arrays decode to Lisp lists.
- Optional fields may be absent depending on endpoint, location, and data availability.
- For One Call endpoint schemas, see =spec/onecall.yaml=.

** Current Project Layout
#+begin_src text
src/
tests/
integration-tests/
spec/
examples/
plans/
#+end_src
