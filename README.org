* OpenWeatherMap API Client

Common Lisp client library for multiple OpenWeatherMap APIs.

** Status
This repository is in early bootstrap.

** Goals
- Idiomatic Common Lisp client interface.
- Strong unit test suite.
- Separate integration test suite for live API checks.
- Project-local OpenAPI specifications per API family.

** Quick Start
*** Prerequisites
- SBCL
- ASDF
- Quicklisp (for external dependencies such as FiveAM)
- Node.js (required for OpenAPI linting with Redocly CLI)
  - Recommended: Node >= 20.19.0 (or >= 22.12.0)
- npm

*** Install development dependencies
#+begin_src sh
npm install
#+end_src

This installs =@redocly/cli= for OpenAPI spec validation.

*** Run unit tests
#+begin_src sh
make unit
#+end_src

*** Run integration tests
Set your API key first:
#+begin_src sh
export OPENWEATHER_API_KEY="your-key"
make integration
#+end_src

*** Validate OpenAPI spec
#+begin_src sh
make spec-check
#+end_src

** Development Workflow
- Use =make check= for local quality checks.
- Keep implementation in =src/=.
- Keep unit tests in =tests/=.
- Keep live API integration tests in =integration-tests/=.
- Keep plans in =plans/=.
- Keep API specs in =spec/= (one file per API family).
- Update =CHANGELOG.md= for each session.

** API Surface Conventions
- Module layout by API family:
  - =src/apis/current.lisp=
  - =src/apis/forecast.lisp=
  - =src/apis/geocoding.lisp=
  - =src/apis/air-pollution.lisp=
  - =src/apis/maps.lisp=
  - =src/client.lisp= keeps shared request/retry/decode pipeline.
- Function naming:
  - =build-*= functions generate endpoint URLs.
  - =make-*= functions return request metadata plist =(:method :get :url "...")=.
  - =fetch-*= functions execute HTTP and return decoded plist responses (or raw tile payload for maps).
- Response strategy:
  - Baseline representation is plist decoded from JSON.
  - Structured/typed response objects may be added later without breaking this baseline.

** Public API (Current Draft)
Configure client settings:
#+begin_src lisp
(openweathermap:configure-api-key "your-api-key")
(openweathermap:configure-client
 :request-timeout-seconds 10
 :max-retries 2
 :retry-backoff-seconds 1)
#+end_src

Fetch JSON-decoded responses (plist form):
#+begin_src lisp
(openweathermap:fetch-onecall 35.0 139.0 :units :metric :lang "en")
(openweathermap:fetch-timemachine 35.0 139.0 1700000000 :units :metric)
(openweathermap:fetch-day-summary 35.0 139.0 "2026-02-15" :units :metric)
(openweathermap:fetch-overview 35.0 139.0 :date "2026-02-16")
#+end_src

Build request URLs only (no network call):
#+begin_src lisp
(openweathermap:build-onecall-url 35.0 139.0 :units :metric)
(openweathermap:build-timemachine-url 35.0 139.0 1700000000)
(openweathermap:build-day-summary-url 35.0 139.0 "2026-02-15")
(openweathermap:build-overview-url 35.0 139.0)
#+end_src

** Current Project Layout
#+begin_src text
src/
tests/
integration-tests/
spec/
examples/
plans/
#+end_src
